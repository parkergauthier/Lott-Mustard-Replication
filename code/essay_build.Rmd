---
title: "Untitled"
author: "Parker Gauthier"
date: "4/15/2022"
output: md_document
---

# Lott and Mustard Replication Excercise

## Introduction

  For years the relationship between crime and gun laws has been a topic of significant contention in the United States. Some argue that restricting gun ownership will deter gun violence, while those on the other end of the aisle believe in quite the opposite. Researchers John Lott and David Mustard aimed to clear up this argument in their paper, "Crime, Deterrence, and Right-to-Carry Concealed Handguns."  The authors attempt to tackle this problem by analyzing the effects of concealed carry laws on various crime rates using econometric models aimed at inferring causality.  The authors conclude that when states give their citizens the right to carry a concealed firearm, violent crime rates decline without a significant increase in accidental gun deaths.  Their findings are quite intriguing, but were their methods sound?
```
```
  The goal of the analysis below will be to assess the models used by Lott and Mustard and see how they stack up to contemporary causal inference methods.  We will look at the same data used by the researchers and first attempt to replicate their results.  We will then used other predictive models to see if we see the same effects depicted by the researchers.  Ultimately, we will assess what methods are the most effective in determining causal effects and highlight the implications of using a faulty model.
  
## Background and Economic Theory



```{r include=FALSE}

#loading packages

if (!("librarian" %in% rownames(utils::installed.packages()))) {
  utils::install.packages("librarian")
}

librarian::shelf( 
  cran_repo = "https://cran.microsoft.com/",
  ask = FALSE,
  stats, 
  here,
  kableExtra,
  ggthemes,
  tidyverse,
  lubridate,
  haven,
  lmtest,
  gganimate,
  gapminder,
  stargazer,
  snakecase,
  mosaic,
  dplyr,
  esquisse,
  plotly,
  modelr,
  rsample,
  caret,
  foreach,
  parallel,
  gamlr,
  glmnet,
  rpart,
  rpart.plot,
  rsample,
  randomForest,
  gbm,
  pdp,
  ggmap,
  devtools,
  estimatr,
  plm,
  bacondecomp,
  TwoWayFEWeights,
  fixest,
  glue,
  did
)

here::i_am("code/include.R")
```


```{r include=FALSE}
#Reading in the data

Lott = read_dta(here("data/UpdatedStateLevelData-2010.dta"))

```


```{r echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
# Table showing rollout

# making data frame for states with year treated
treat_table =  Lott %>%
  select(state, shalll, year) %>%
  group_by(state) %>% 
  filter(shalll == 1 , year >= 1977 & year<=1992) %>%
  summarise(treatment_year = min(year)) %>% 
  mutate(treatment_year = ifelse(treatment_year <= 1977, yes = "Treated Entire Period", no = treatment_year), order = ifelse(treatment_year == "Treated Entire Period", yes = 1, no = treatment_year)) %>%  
  arrange(order) %>% 
  select(-order)


knitr::kable(treat_table, col.names = c("State Name", "Year Treated"), caption = "Table 1")
```


## Data

```{r echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}

# Table with summary statistics

Lott_select = Lott %>% 
  select(state, year, aovio, aopro, aomur, aorap, aorob, aobur, aolar, aoaut, ratvio, ratpro, ratmur, ratrap, rataga, ratrob, rataut, ratbur, ratlar)

namies = c("Arest Rates - Violent Crime", "Property Crime", "Murder", "Rape", "Robbery", "Burglary", "Larceny", "Auto Theft", "Crime Rates - Violent Crime", "Property Crime", "Murder", "Rape", "Agravated Assault", "Robbery","Auto Theft", "Burglary", "Larceny")

sum_tab_sd = Lott_select %>% 
  select(year, aovio, aopro, aomur, aorap, aorob, aobur, aolar, aoaut, ratvio, ratpro, ratmur, ratrap, rataga, ratrob, rataut, ratbur, ratlar) %>%
  filter(year >= 1977 & year <= 1992) %>% 
  select(-year) %>% 
  summarise_all(sd, na.rm = TRUE) %>%
  round(2) %>% 
  t()

sum_tab_mean = Lott_select %>% 
  select(year, aovio, aopro, aomur, aorap, aorob, aobur, aolar, aoaut, ratvio, ratpro, ratmur, ratrap, rataga, ratrob, rataut, ratbur, ratlar) %>%
  filter(year >= 1977 & year <= 1992) %>% 
  select(-year) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  round(2) %>% 
  t() %>% 
  cbind(sum_tab_sd)


row.names(sum_tab_mean) = namies

kable(sum_tab_mean, col.names = c("Mean", "Sd"), caption = "Summary Statistics")
```

## Empircal Model and Estimation

  The first model we will look at will be similar to the model originally used by Lott & Mustard in their paper. This model, 'Twoway Fixed Effects,' is a type of difference-in-difference design where we compare our observations to a fixed effect to identify whether a treated group has a different trend than a control group. 
  
```{r include = FALSE}
#TWFE
Lott_mutate = Lott %>% 
  filter(year >= 1977 & year <= 1992) %>% 
  mutate(lvio = log(ratvio), lmur = log(ratmur), laga = log(rataga), lrob = log(ratrob), lpro = log(ratpro), lbur = log(ratbur), llar = log(ratlar), laut = log(rataut)) %>% group_by(state) %>% 
  mutate(treated = max(shalll))

treated_table = Lott_mutate %>% 
  group_by(state) %>% 
  summarize(count = sum(shalll)) %>% 
  mutate(treatment_year = ifelse(count > 0, 1992 + 1 -count,0))


Lott_treat = merge(treated_table, Lott_mutate, by = "state")

y_vars = c("lvio", "lpro", "lmur", "lrap", "laga", "lrob", "lbur", "llar", "laut")

ao_vars = c("aovio", "aopro", "aomur", "aorap", "aoaga", "aorob", "aobur", "aolar", "aoaut")

len_ = length(ao_vars)

foreach(y = 1:len_) %do% {
  y_var = y_vars[y]
  ao_var = ao_vars[y]
  fixie = "| state + year"
  
  specfication = as.formula(paste0(y_var, "~shalll + density + rpcpi + rpcim + rpcui + rpcrpo + ppwm1019 + ppwm2029 + ppwm3039 + ppwm4049 + ppwm5064 + ppwf1019 + ppwf2029 + ppwf3039 + ppwf4049 + ppwf5064 + ppbm1019 + ppbm2029 + ppbm3039 + ppbm4049 + ppbm5064 + ppbf1019 + ppbf2029 + ppbf3039 + ppbf4049 + ppbf5064 +ppnm1019 + ppnm2029 + ppnm3039 + ppnm4049 + ppnm5064 + ppnf1019 + ppnf1019 + ppnf2029 + ppnf3039 + ppnf4049 + ppnf5064 +", ao_var, fixie))
  
  model_fe = feols(fml = specfication, data = Lott_treat)

  model_names = paste("twfe", y_var, sep = "_")
  assign(model_names, model_fe)
  
  fname_twfe = paste0(model_names, ".RDs")
  save(file = file.path("C:/Users/Parker/Documents/School/UT/Causal_Inference/Lott-Mustard-Replication", "output", "models", fname_twfe), list = "model_fe")
}
```



```{r include = FALSE}
#bacon decomp

foreach(y=1:len_) %do% {
  y_var = y_vars[y]
  
  bacon_specs = as.formula(paste(y_var, "shalll", sep = " ~ "))

  bacon_model = bacon(bacon_specs,
                    data = Lott_treat,
                    id_var = "fipsstat",
                    time_var = "year") %>% 
    group_by(type) %>% 
    summarise(av_estimate = weighted.mean(estimate, weight),
              weight = sum(weight))
  
  bacon_names = paste("bacon", y_var, sep = "_")
  assign(bacon_names, bacon_model)
  
  fname_bacon = paste0(bacon_names, ".RDs")
  save(file = file.path(here(), "output", "models", fname_bacon), list = "bacon_model")
}

```


```{r include=FALSE}
#Calloway Sant'anna
foreach(y=1:len_) %do% {
  y_var = y_vars[y]
  ao_var = ao_vars[y]

  cs_specs = as.formula(paste("~ +", ao_var))

  att_sa <- att_gt(yname = y_var, # LHS variable
               tname = "year", # time variable
               idname = "fipsstat", # id variable
               gname = "treatment_year", # first treatment period variable
               data = Lott_treat, # data
               xformla = cs_specs, # no covariates
               est_method = "dr", # "dr" is doubly robust. "ipw" is inverse probability weighting. "reg" is regression
               control_group = "notyettreated", # set the comparison group which is either "nevertreated" or "notyettreated" 
               bstrap = TRUE, # if TRUE compute bootstrapped SE
               biters = 1000, # number of bootstrap iterations
               print_details = FALSE, # if TRUE, print detailed results
               clustervars = "fipsstat", # cluster level
               panel = TRUE) # whether the data is panel or repeated cross-sectional


  cs_model = aggte(att_sa, type = "group", balance_e = TRUE, na.rm = TRUE)
  
  cs_names = paste("CS", y_var, sep = "_")
  assign(cs_names, cs_model)
  
  fname_cs = paste0(cs_names, ".RDs")
  save(file = file.path(here(), "output", "models", fname_cs), list = "cs_model")
}

```


```{r include = FALSE}
# Sun and Abraham

foreach(y = 1:len_) %do% {
  y_var = y_vars[y]
  ao_var = ao_vars[y]
  
  sa_spec = as.formula(paste0(y_var, "~ sunab(treatment_year, year) + density + rpcpi + rpcim + rpcui + rpcrpo + ppwm1019 + ppwm2029 + ppwm3039 + ppwm4049 + ppwm5064 + ppwf1019 + ppwf2029 + ppwf3039 + ppwf4049 + ppwf5064 + ppbm1019 + ppbm2029 + ppbm3039 + ppbm4049 + ppbm5064 + ppbf1019 + ppbf2029 + ppbf3039 + ppbf4049 + ppbf5064 +ppnm1019 + ppnm2029 + ppnm3039 + ppnm4049 + ppnm5064 + ppnf1019 + ppnf1019 + ppnf2029 + ppnf3039 + ppnf4049 + ppnf5064 +", ao_var))

  sa_model = feols(fml = sa_spec,
                 data = Lott_treat,
                 subset = ~ year < 1992,
                 vcov = ~fipsstat + year)

  sa_names = paste("SA", y_var, sep = "_")
  assign(sa_names, sa_model)
  
  fname_sa = paste0(sa_names, ".RDs")
  save(file = file.path(here(), "output", "models", fname_sa), list = "sa_model")
}
```

```{r include = FALSE}
effects = foreach(y = 1:len_, .combine = rbind) %do% {
  y_var = y_vars[y]
  
  twfe_name = paste("twfe", y_var, sep = "_")
  fname_twfe = paste0(twfe_name, ".RDs")
  
  bacon_name = paste("twfe", y_var, sep="_")
  fname_bacon = paste0(bacon_name, ".RDs")
  
  cs_name = paste("CS", y_var, sep = "_")
  fname_cs = paste0(cs_name, ".RDs")
  
  sa_name = paste("SA", y_var, sep = "_")
  fname_sa = paste0(sa_name, ".RDs")
  
  load(file.path(here(), "output", "models", fname_twfe))
  load(file.path(here(), "output", "models", fname_cs))
  load(file.path(here(), "output", "models", fname_sa))
  load(file.path(here(), "output", "models", fname_bacon))
  
  estimates = c(y_var, model_fe[["coefficients"]][["shalll"]], cs_model[["overall.att"]])
  se = c(y_var, model_fe[["se"]][["shalll"]], cs_model[["overall.se"]])
  p = c(y_var, model_fe[["coeftable"]][["Pr(>|t|)"]][1], cs_model[["overall.se"]])
  
  rbind(estimates, se)
} %>% 
  as.data.frame()

colnames(effects) = c("Target Variable", "TWFE", "Calloway_SantAnna")
rownames(effects) = NULL

effects$TWFE = round(as.numeric(effects$TWFE), 4)
effects$Calloway_SantAnna = round(as.numeric(effects$Calloway_SantAnna), 4)

effects = effects %>% 
  mutate("Target Variable" = ifelse(row_number()%%2 == 0, "", y_vars)) %>% 
  mutate(TWFE = ifelse(row_number()%%2 == 0, paste0("(", TWFE, ")"), TWFE), 
         Calloway_SantAnna = ifelse(row_number()%%2 == 0, paste0("(",Calloway_SantAnna, ")"),Calloway_SantAnna))

effects_table = stargazer(effects,
                          type= "text",
                          summary = FALSE,
                          rownames = FALSE)

write(effects_table, file=file.path(here(), "output", "tables", "effects.txt"))
```

```{r echo = FALSE}
effects_table = stargazer(effects,
                          type= "text",
                          summary = FALSE,
                          rownames = FALSE)
```
